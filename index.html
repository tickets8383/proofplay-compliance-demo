<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ProofPlay Compliance Engine ‚Äî Audit Infrastructure for Regulated Industries</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a1628;
            color: #f0f4f8;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
            background: #00d4aa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        h1 {
            font-size: 38px;
            font-weight: 700;
            color: #f0f4f8;
        }
        
        .tagline {
            color: #00d4aa;
            font-size: 16px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .subtitle {
            color: #8b9cb3;
            font-size: 16px;
            max-width: 650px;
            margin: 0 auto;
        }
        
        .compliance-badges {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 8px 16px;
            background: #152238;
            border: 1px solid #2d4a6f;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #00d4aa;
        }
        
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00d4aa;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8b9cb3;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .use-cases {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 768px) {
            .use-cases {
                grid-template-columns: 1fr;
            }
        }
        
        .use-case {
            background: #152238;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #2d4a6f;
            border-top: 3px solid #00d4aa;
        }
        
        .use-case-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }
        
        .use-case-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .use-case-desc {
            font-size: 13px;
            color: #8b9cb3;
        }
        
        .demos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 768px) {
            .demos {
                grid-template-columns: 1fr;
            }
        }
        
        .demo-card {
            background: #152238;
            border-radius: 16px;
            padding: 28px;
            border: 1px solid #2d4a6f;
        }
        
        .demo-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .demo-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .demo-icon.rules { background: #00d4aa; }
        .demo-icon.audit { background: #ffc857; }
        
        .demo-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .demo-description {
            color: #8b9cb3;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-group label {
            display: block;
            font-size: 12px;
            color: #8b9cb3;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: #0a1628;
            border: 1px solid #2d4a6f;
            border-radius: 8px;
            color: #f0f4f8;
            font-size: 14px;
            font-family: inherit;
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #00d4aa;
        }
        
        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #00d4aa;
            color: #0a1628;
        }
        
        .btn-primary:hover {
            background: #00e8bb;
        }
        
        .btn-secondary {
            background: #ffc857;
            color: #0a1628;
        }
        
        .btn-secondary:hover {
            background: #ffd477;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 20px;
            padding: 16px;
            background: #0a1628;
            border-radius: 8px;
            border: 1px solid #2d4a6f;
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .result-status {
            font-size: 14px;
            font-weight: 600;
        }
        
        .result-status.success { color: #00d4aa; }
        .result-status.error { color: #ff6b6b; }
        .result-status.warning { color: #ffc857; }
        
        .legal-seal-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
            cursor: help;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .legal-seal-badge:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }
        
        .result-time {
            font-size: 12px;
            color: #8b9cb3;
        }
        
        .result-body {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #8b9cb3;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .result-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .result-body::-webkit-scrollbar-track {
            background: #152238;
        }
        
        .result-body::-webkit-scrollbar-thumb {
            background: #2d4a6f;
            border-radius: 3px;
        }
        
        .quick-examples {
            margin-bottom: 16px;
        }
        
        .quick-examples label {
            display: block;
            font-size: 12px;
            color: #8b9cb3;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .example-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .chip {
            padding: 6px 12px;
            background: #1e3a5f;
            border-radius: 20px;
            font-size: 11px;
            color: #f0f4f8;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .chip:hover {
            border-color: #00d4aa;
        }
        
        .api-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2d4a6f;
        }
        
        .api-url {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: #8b9cb3;
            word-break: break-all;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .section-subtitle {
            font-size: 14px;
            color: #8b9cb3;
            text-align: center;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .feature {
            background: #152238;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            border: 1px solid #2d4a6f;
        }
        
        .feature-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .feature-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .feature-desc {
            font-size: 12px;
            color: #8b9cb3;
        }
        
        .architecture {
            background: #152238;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 50px;
            border: 1px solid #2d4a6f;
        }
        
        .arch-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .arch-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .arch-step {
            flex: 1;
            min-width: 140px;
            text-align: center;
            padding: 16px;
            background: #0a1628;
            border-radius: 8px;
            border: 1px solid #2d4a6f;
        }
        
        .arch-step-num {
            width: 28px;
            height: 28px;
            background: #00d4aa;
            color: #0a1628;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .arch-step-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .arch-step-desc {
            font-size: 11px;
            color: #8b9cb3;
        }
        
        .arch-arrow {
            color: #2d4a6f;
            font-size: 20px;
        }
        
        @media (max-width: 768px) {
            .arch-arrow {
                display: none;
            }
        }
        
        .cta-section {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #152238 0%, #1e3a5f 100%);
            border-radius: 16px;
            margin-bottom: 40px;
            border: 1px solid #2d4a6f;
        }
        
        .cta-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .cta-desc {
            color: #8b9cb3;
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .cta-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .cta-btn.primary {
            background: #00d4aa;
            color: #0a1628;
        }
        
        .cta-btn.primary:hover {
            background: #00e8bb;
        }
        
        .cta-btn.secondary {
            background: #1e3a5f;
            color: #f0f4f8;
            border: 1px solid #2d4a6f;
        }
        
        .cta-btn.secondary:hover {
            border-color: #00d4aa;
        }
        
        footer {
            text-align: center;
            padding: 30px;
            border-top: 1px solid #2d4a6f;
            color: #8b9cb3;
            font-size: 14px;
        }
        
        footer a {
            color: #00d4aa;
            text-decoration: none;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #0a1628;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .verification-details {
            margin-top: 12px;
            padding: 12px;
            background: #1e3a5f;
            border-radius: 6px;
        }

        .verification-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 4px 0;
        }

        .verification-label {
            color: #8b9cb3;
        }

        .verification-value {
            color: #00d4aa;
            font-family: monospace;
        }

        .verification-value.invalid {
            color: #ff6b6b;
        }
        
        .verification-value.warning {
            color: #ffc857;
        }

        #game-id.audit-highlight {
            border-color: #00d4aa;
            box-shadow: 0 0 0 2px rgba(0,212,170,0.2);
            transition: all 0.3s ease;
        }

        .audit-stream-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .audit-stream-table th {
            text-align: left;
            padding: 8px;
            font-size: 11px;
            color: #8b9cb3;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #2d4a6f;
        }

        .audit-stream-table td {
            padding: 8px;
            font-size: 12px;
            color: #8b9cb3;
            border-bottom: 1px solid #2d4a6f;
        }

        .audit-stream-table tr:hover {
            background: #1e3a5f;
        }

        .audit-id-link {
            color: #00d4aa;
            cursor: pointer;
            text-decoration: underline;
            font-family: monospace;
        }

        .audit-id-link:hover {
            color: #00e8bb;
        }

        .audit-status-valid {
            color: #00d4aa;
        }
        
        .audit-status-invalid {
            color: #ff6b6b;
        }
        
        .audit-status-warning {
            color: #ffc857;
        }

        /* Logic Visualization Tab System */
        .result-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            border-bottom: 2px solid #2d4a6f;
        }

        .result-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #8b9cb3;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .result-tab:hover {
            color: #00d4aa;
        }

        .result-tab.active {
            color: #00d4aa;
            border-bottom-color: #00d4aa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Mermaid Graph Styling */
        .mermaid-container {
            background: #0a1628;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: auto;
        }

        .mermaid-container svg {
            max-width: 100%;
        }

        /* Mermaid node styling overrides */
        .mermaid .node rect,
        .mermaid .node circle,
        .mermaid .node ellipse,
        .mermaid .node polygon,
        .mermaid .node path {
            fill: #152238 !important;
            stroke: #00d4aa !important;
            stroke-width: 2px !important;
        }

        .mermaid .node.negated rect,
        .mermaid .node.negated polygon {
            stroke: #ff6b6b !important;
            fill: #2a1a1a !important;
        }

        .mermaid .edgePath .path {
            stroke: #00d4aa !important;
            stroke-width: 2px !important;
        }

        .mermaid .edgeLabel {
            background-color: #0a1628 !important;
            color: #ffc857 !important;
        }

        .mermaid .label {
            color: #f0f4f8 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .mermaid .cluster rect {
            fill: #1e3a5f !important;
            stroke: #2d4a6f !important;
        }

        .graph-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 12px;
            font-size: 11px;
            color: #8b9cb3;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            border: 2px solid;
        }

        .legend-color.variable {
            background: #152238;
            border-color: #00d4aa;
        }

        .legend-color.operator {
            background: #152238;
            border-color: #ffc857;
        }

        .legend-color.negated {
            background: #2a1a1a;
            border-color: #ff6b6b;
        }

        .no-graph-message {
            color: #8b9cb3;
            font-style: italic;
            text-align: center;
            padding: 40px;
        }
    </style>
    <!-- Mermaid.js for Logic Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        // Initialize Mermaid with dark theme and strict security
        mermaid.initialize({
            startOnLoad: false,
            securityLevel: 'strict',
            theme: 'dark',
            themeVariables: {
                primaryColor: '#152238',
                primaryTextColor: '#f0f4f8',
                primaryBorderColor: '#00d4aa',
                lineColor: '#00d4aa',
                secondaryColor: '#1e3a5f',
                tertiaryColor: '#0a1628',
                background: '#0a1628',
                mainBkg: '#152238',
                nodeBorder: '#00d4aa',
                clusterBkg: '#1e3a5f',
                titleColor: '#f0f4f8',
                edgeLabelBackground: '#0a1628'
            },
            flowchart: {
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 50,
                htmlLabels: true
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üõ°Ô∏è</div>
                <h1>ProofPlay Compliance Engine</h1>
            </div>
            <p class="tagline">Audit Infrastructure for Regulated Industries</p>
            <p class="subtitle">
                Formal logic verification, tamper-proof audit trails, and cryptographic timestamps 
                for healthcare, insurance, and financial services compliance.
            </p>
            <div class="compliance-badges">
                <span class="badge">HIPAA Ready</span>
                <span class="badge">SOC2 Compatible</span>
                <span class="badge">GDPR Compliant</span>
                <span class="badge">RFC 3161 Timestamps</span>
            </div>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value">67K+</div>
                    <div class="stat-label">Lines of Code</div>
                </div>
                <div class="stat">
                    <div class="stat-value">19</div>
                    <div class="stat-label">API Endpoints</div>
                </div>
                <div class="stat">
                    <div class="stat-value">1GB</div>
                    <div class="stat-label">Persistent Storage</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="api-status">...</div>
                    <div class="stat-label">API Status</div>
                </div>
            </div>
        </header>

        <h2 class="section-title">Healthcare & Insurance Use Cases</h2>
        <p class="section-subtitle">Built for industries where every decision needs documentation and every rule needs verification.</p>
        
        <div class="use-cases">
            <div class="use-case">
                <div class="use-case-icon">üìã</div>
                <div class="use-case-title">Claims Rule Verification</div>
                <div class="use-case-desc">Verify that claims processing rules are logically consistent and don't contradict each other before deployment.</div>
            </div>
            <div class="use-case">
                <div class="use-case-icon">üîç</div>
                <div class="use-case-title">Decision Audit Trails</div>
                <div class="use-case-desc">Every adjudication decision gets a cryptographic timestamp and hash-chained log entry. Tamper-evident by design.</div>
            </div>
            <div class="use-case">
                <div class="use-case-icon">‚öñÔ∏è</div>
                <div class="use-case-title">Regulatory Evidence</div>
                <div class="use-case-desc">Export court-admissible evidence packages with RFC 3161 timestamps for audits, disputes, and litigation.</div>
            </div>
        </div>

        <div class="demos">
            <!-- Policy Rule Verification -->
            <div class="demo-card">
                <div class="demo-header">
                    <div class="demo-icon rules">üìú</div>
                    <div class="demo-title">Policy Rule Verifier</div>
                </div>
                <p class="demo-description">
                    Verify business rules for logical consistency before deployment.
                </p>
                
                <!-- Mode Toggle -->
                <div class="mode-toggle" style="display: flex; margin-bottom: 16px; background: #0a1628; border-radius: 8px; padding: 4px;">
                    <button id="mode-formal" class="mode-btn active" onclick="setMode('formal')" style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #00d4aa; color: #0a1628;">
                        Formal Logic
                    </button>
                    <button id="mode-business" class="mode-btn" onclick="setMode('business')" style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: transparent; color: #8b9cb3;">
                        Business Mode
                    </button>
                </div>
                
                <div id="mode-description" style="font-size: 11px; color: #8b9cb3; margin-bottom: 16px; padding: 10px; background: #1e3a5f; border-radius: 6px;">
                    <strong style="color: #00d4aa;">Formal Mode:</strong> Deterministic verification via Z3 SMT solver. Use logical notation (‚àß ‚à® ‚Üí ¬¨). Production-grade.
                </div>
                
                <div class="quick-examples">
                    <label>Example Expressions:</label>
                    <div class="example-chips" id="example-chips">
                        <span class="chip" onclick="setExample('coverage')">Coverage ‚Üí Approve</span>
                        <span class="chip" onclick="setExample('contradiction')">Contradiction</span>
                        <span class="chip" onclick="setExample('deductible')">Deductible Logic</span>
                        <span class="chip" onclick="setExample('circular')">Circular Dependency</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="input-label">Formal Logic Expression</label>
                    
                    <!-- Operator Palette -->
                    <div style="display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="insertAtCursor(document.getElementById('logic-input'), '‚àß')" 
                                style="padding: 6px 12px; background: #1e3a5f; border: 1px solid #2d4a6f; border-radius: 4px; color: #f0f4f8; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" 
                                onmouseover="this.style.background='#2d4a6f'" 
                                onmouseout="this.style.background='#1e3a5f'"
                                title="AND">‚àß</button>
                        <button type="button" onclick="insertAtCursor(document.getElementById('logic-input'), '‚à®')" 
                                style="padding: 6px 12px; background: #1e3a5f; border: 1px solid #2d4a6f; border-radius: 4px; color: #f0f4f8; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" 
                                onmouseover="this.style.background='#2d4a6f'" 
                                onmouseout="this.style.background='#1e3a5f'"
                                title="OR">‚à®</button>
                        <button type="button" onclick="insertAtCursor(document.getElementById('logic-input'), '¬¨')" 
                                style="padding: 6px 12px; background: #1e3a5f; border: 1px solid #2d4a6f; border-radius: 4px; color: #f0f4f8; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" 
                                onmouseover="this.style.background='#2d4a6f'" 
                                onmouseout="this.style.background='#1e3a5f'"
                                title="NOT">¬¨</button>
                        <button type="button" onclick="insertAtCursor(document.getElementById('logic-input'), '‚Üí')" 
                                style="padding: 6px 12px; background: #1e3a5f; border: 1px solid #2d4a6f; border-radius: 4px; color: #f0f4f8; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" 
                                onmouseover="this.style.background='#2d4a6f'" 
                                onmouseout="this.style.background='#1e3a5f'"
                                title="IMPLIES">‚Üí</button>
                        <button type="button" onclick="insertAtCursor(document.getElementById('logic-input'), '(')" 
                                style="padding: 6px 12px; background: #1e3a5f; border: 1px solid #2d4a6f; border-radius: 4px; color: #f0f4f8; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" 
                                onmouseover="this.style.background='#2d4a6f'" 
                                onmouseout="this.style.background='#1e3a5f'"
                                title="Left Parenthesis">(</button>
                        <button type="button" onclick="insertAtCursor(document.getElementById('logic-input'), ')')" 
                                style="padding: 6px 12px; background: #1e3a5f; border: 1px solid #2d4a6f; border-radius: 4px; color: #f0f4f8; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" 
                                onmouseover="this.style.background='#2d4a6f'" 
                                onmouseout="this.style.background='#1e3a5f'"
                                title="Right Parenthesis">)</button>
                    </div>
                    
                    <textarea id="logic-input" placeholder="e.g., (A ‚àß B) ‚Üí C">((active_policy ‚àß premium_paid) ‚àß (valid_claim_date ‚àß ¬¨excluded_condition)) ‚Üí claim_approved</textarea>
                    
                    <!-- Normalized Preview -->
                    <div id="normalized-preview" style="display: none; font-size: 11px; color: #ffc857; margin-top: 6px; padding: 6px; background: #1e3a5f; border-radius: 4px;">
                        <strong>Normalized:</strong> <span id="normalized-text"></span>
                    </div>
                    
                    <!-- Validation Errors -->
                    <div id="validation-errors" style="display: none; font-size: 11px; color: #ff6b6b; margin-top: 6px; padding: 6px; background: #2a1a1a; border-radius: 4px; border: 1px solid #ff6b6b;">
                        <strong>Validation Errors:</strong>
                        <ul id="validation-errors-list" style="margin: 4px 0 0 0; padding-left: 20px;"></ul>
                    </div>
                    
                    <p id="logic-description" style="font-size: 11px; color: #8b9cb3; margin-top: 6px;">If policy active AND premium paid AND valid date AND not excluded, then approve</p>
                </div>
                
                <button class="btn btn-primary" onclick="verifyLogic()" id="verify-btn">
                    Verify Rule Consistency
                </button>
                
                <div class="result" id="logic-result">
                    <div class="result-header">
                        <span class="result-status" id="logic-status">‚Äî</span>
                        <span class="result-time" id="logic-time">‚Äî</span>
                    </div>
                    <div class="verification-details" id="logic-details"></div>
                    
                    <!-- Tab System -->
                    <div class="result-tabs" id="result-tabs" style="display: none;">
                        <button class="result-tab active" onclick="switchTab('graph')" id="tab-graph">üîÄ Logic Graph</button>
                        <button class="result-tab" onclick="switchTab('json')" id="tab-json">üìÑ JSON Result</button>
                    </div>
                    
                    <!-- Graph Tab Content -->
                    <div class="tab-content active" id="tab-content-graph">
                        <div class="mermaid-container" id="mermaid-container">
                            <div class="no-graph-message">Run verification to see logic visualization</div>
                        </div>
                        <div class="graph-legend" id="graph-legend" style="display: none;">
                            <div class="legend-item">
                                <div class="legend-color variable"></div>
                                <span>Variable</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color operator" style="border-color: #ffc857;"></div>
                                <span>Operator</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color negated"></div>
                                <span>Negated</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JSON Tab Content -->
                    <div class="tab-content" id="tab-content-json">
                        <div class="result-body" id="logic-body"></div>
                    </div>
                </div>
                
                <div class="api-info">
                    <div class="api-url" id="api-endpoint-info">POST /verify ‚Äî Formal verification via Z3 SMT solver (deterministic)</div>
                </div>
            </div>

            <!-- Audit Trail Demo -->
            <div class="demo-card">
                <div class="demo-header">
                    <div class="demo-icon audit">üîê</div>
                    <div class="demo-title">Audit Trail Verifier</div>
                </div>
                <p class="demo-description">
                    Verify the cryptographic integrity of any logged decision. Each entry is committed 
                    to an RFC 3161 timestamp authority ‚Äî proving when decisions were made.
                </p>
                
                <div class="input-group">
                    <label>Audit Record ID (from GPMSC /verify response)</label>
                    <!-- VERCEL CACHE BUST: 2024-12-19-v4 - Input field MUST be empty, no bingo game ID -->
                    <input type="text" id="game-id" placeholder="Will auto-fill after verification" value="" autocomplete="off">
                    <p style="font-size: 11px; color: #ffc857; margin-top: 6px;">
                        ‚ö†Ô∏è This field expects an audit_id from GPMSC API, NOT a bingo game_id from ProofPlay
                    </p>
                </div>
                
                <button class="btn btn-secondary" onclick="verifyAuditIntegrity()" id="game-btn">
                    Verify Audit Integrity
                </button>
                
                <div class="result" id="game-result">
                    <div class="result-header">
                        <span class="result-status" id="game-status">‚Äî</span>
                        <span class="result-time" id="game-time">‚Äî</span>
                    </div>
                    <div class="verification-details" id="game-details"></div>
                    <div class="result-body" id="game-body"></div>
                </div>
                
                <div class="api-info">
                    <div class="api-url">GET /audit/{id}/integrity ‚Äî Hash-chain verification</div>
                </div>
            </div>

            <!-- Live Audit Stream -->
            <div class="demo-card">
                <div class="demo-header">
                    <div class="demo-icon audit">üìä</div>
                    <div class="demo-title">Live Audit Stream</div>
                </div>
                <p class="demo-description">
                    Recent verification decisions. Click any ID to verify its integrity.
                </p>
                
                <div id="audit-stream">
                    <table class="audit-stream-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Endpoint</th>
                                <th>Status</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody id="audit-stream-body">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #8b9cb3; padding: 20px;">
                                    Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="api-info">
                    <div class="api-url">GET /audit/recent ‚Äî Recent audit records</div>
                </div>
            </div>
        </div>

        <div class="architecture">
            <div class="arch-title">How It Works: Commit-Before-Record Architecture</div>
            <div class="arch-flow">
                <div class="arch-step">
                    <div class="arch-step-num">1</div>
                    <div class="arch-step-title">Decision Made</div>
                    <div class="arch-step-desc">Claim approved, denied, or flagged</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-step">
                    <div class="arch-step-num">2</div>
                    <div class="arch-step-title">Hash Generated</div>
                    <div class="arch-step-desc">SHA-256 commitment created</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-step">
                    <div class="arch-step-num">3</div>
                    <div class="arch-step-title">Timestamp Anchored</div>
                    <div class="arch-step-desc">RFC 3161 third-party proof</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-step">
                    <div class="arch-step-num">4</div>
                    <div class="arch-step-title">Chain Extended</div>
                    <div class="arch-step-desc">Hash-linked to prior records</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-step">
                    <div class="arch-step-num">5</div>
                    <div class="arch-step-title">Verifiable Forever</div>
                    <div class="arch-step-desc">Anyone can prove integrity</div>
                </div>
            </div>
        </div>

        <h2 class="section-title">Compliance Infrastructure</h2>
        <div class="features">
            <div class="feature">
                <div class="feature-icon">üìú</div>
                <div class="feature-title">RFC 3161 Timestamps</div>
                <div class="feature-desc">Third-party, legally recognized cryptographic proof of when records were created</div>
            </div>
            <div class="feature">
                <div class="feature-icon">‚õìÔ∏è</div>
                <div class="feature-title">Hash-Chained Logs</div>
                <div class="feature-desc">Tamper-evident, append-only audit trail ‚Äî any modification is detectable</div>
            </div>
            <div class="feature">
                <div class="feature-icon">üßÆ</div>
                <div class="feature-title">SMT Solver (Z3)</div>
                <div class="feature-desc">Formal verification of business rules using Microsoft's Z3 theorem prover</div>
            </div>
            <div class="feature">
                <div class="feature-icon">üì§</div>
                <div class="feature-title">Evidence Export</div>
                <div class="feature-desc">Court-admissible evidence packages for audits, disputes, and regulatory review</div>
            </div>
        </div>

        <div class="cta-section">
            <div class="cta-title">Interested in Learning More?</div>
            <div class="cta-desc">
                67,000+ lines of production infrastructure. 85-page engineering specification. 
                Ready for integration or licensing discussions.
            </div>
            <div class="cta-buttons">
                <a href="/cdn-cgi/l/email-protection#26524f454d4352551e151e15664f454a4953420845494b" class="cta-btn primary">Contact for Demo</a>
                <a href="https://github.com/tickets8383/proofplay-docs" target="_blank" class="cta-btn secondary">API Documentation</a>
            </div>
        </div>

        <footer>
            Built on 67,000+ lines of enterprise audit infrastructure.<br>
            <a href="https://rapidapi.com/watkins905/api/gpm-sc-reasoning-verifier/" target="_blank">RapidAPI</a> ¬∑ 
            <a href="https://github.com/tickets8383/proofplay-docs" target="_blank">Documentation</a> ¬∑ 
            <a href="/cdn-cgi/l/email-protection#75011c161e1001064d464d46351c16191a00115b161a18"><span class="__cf_email__" data-cfemail="a5d1ccc6cec0d1d69d969d96e5ccc6c9cad0c18bc6cac8">[email&#160;protected]</span></a>
        </footer>
    </div>

    <script>
        // VERSION: 2024-12-19-v3 - Added input normalization, validation, and Mermaid hardening
        // Configuration - override via query param: ?api=https://... or ?gpmsc=https://...&proofplay=https://...
        // CRITICAL: Audit log database is on GPMSC API (gpmsc-api.onrender.com), NOT ProofPlay
        
        // ============================================================
        // INPUT HARDENING CONSTANTS
        // ============================================================
        const MAX_EXPR_LEN = 2000;
        const MAX_DEPTH = 50;
        const MAX_TOKENS_FOR_DIAGRAM = 250;
        const RENDER_DEBOUNCE_MS = 300;
        
        const CONFIG = {
            GPMSC_API_URL: new URLSearchParams(window.location.search).get('gpmsc') 
                || new URLSearchParams(window.location.search).get('api')
                || 'https://gpmsc-api.onrender.com',
            PROOFPLAY_API_URL: new URLSearchParams(window.location.search).get('proofplay')
                || 'https://proofplay-sx3q.onrender.com'
        };
        
        // VALIDATE CONFIG IMMEDIATELY - HARD STOP if wrong
        if (CONFIG.GPMSC_API_URL.includes('proofplay') || CONFIG.GPMSC_API_URL.includes('sx3q')) {
            console.error('‚ùå‚ùå‚ùå CRITICAL: CONFIG.GPMSC_API_URL is WRONG!', CONFIG.GPMSC_API_URL);
            alert('ERROR: GPMSC_API_URL is pointing to ProofPlay! This is wrong. Please refresh.');
            CONFIG.GPMSC_API_URL = 'https://gpmsc-api.onrender.com'; // Force correct value
        }
        
        // Log configuration on load for debugging
        console.log('=== GPMSC AUDIT TRAIL DEMO v5 ===');
        console.log('API Configuration:', JSON.stringify(CONFIG, null, 2));
        console.log('Audit log is stored in GPMSC API:', CONFIG.GPMSC_API_URL);
        console.log('ProofPlay API (NOT used for audit):', CONFIG.PROOFPLAY_API_URL);
        console.log('‚úÖ CONFIG validated - GPMSC_API_URL is correct');
        
        // CRITICAL: Ensure audit ID input is ALWAYS empty on load (no default bingo game ID)
        // This runs immediately and on DOMContentLoaded to catch any cached values
        (function() {
            function clearAuditInput() {
                const auditInput = document.getElementById('game-id');
                if (auditInput) {
                    const oldValue = auditInput.value;
                    if (oldValue && (oldValue.length > 0)) {
                        console.warn('‚ö†Ô∏è CLEARING pre-filled value from audit input:', oldValue);
                        auditInput.value = '';
                        auditInput.setAttribute('value', ''); // Force HTML attribute too
                    }
                }
            }
            // Run immediately
            clearAuditInput();
            // Run on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', clearAuditInput);
            } else {
                clearAuditInput();
            }
            // Run after a short delay to catch any late-setting code
            setTimeout(clearAuditInput, 100);
        })();
        
        let currentMode = 'formal';
        
        // ============================================================
        // INPUT NORMALIZATION & VALIDATION
        // ============================================================
        
        /**
         * Normalizes user input by converting friendly operators to strict mathematical notation
         * @param {string} raw - Raw user input
         * @returns {{normalized: string, changed: boolean, warnings: string[]}}
         */
        function normalizeLogicInput(raw) {
            if (!raw || typeof raw !== 'string') {
                return { normalized: '', changed: false, warnings: [] };
            }
            
            let normalized = raw;
            const warnings = [];
            let changed = false;
            
            // Protect variable tokens like V(x) from replacement
            const varPattern = /V\([^)]+\)/g;
            const varMatches = [];
            let match;
            while ((match = varPattern.exec(normalized)) !== null) {
                varMatches.push({ text: match[0], index: match.index });
            }
            
            // Replace variables with placeholders
            const placeholders = [];
            varMatches.forEach((m, i) => {
                const placeholder = `__VAR_PLACEHOLDER_${i}__`;
                placeholders.push({ placeholder, original: m.text });
                normalized = normalized.substring(0, m.index) + placeholder + normalized.substring(m.index + m.text.length);
            });
            
            // Normalize whitespace (collapse multiple spaces)
            const beforeWhitespace = normalized;
            normalized = normalized.replace(/\s+/g, ' ').trim();
            if (beforeWhitespace !== normalized) {
                changed = true;
            }
            
            // Convert friendly operators (case-insensitive, whole word or symbol)
            const replacements = [
                // AND variations
                { pattern: /\bAND\b/gi, replacement: '‚àß' },
                { pattern: /\band\b/gi, replacement: '‚àß' },
                { pattern: /&&/g, replacement: '‚àß' },
                // OR variations
                { pattern: /\bOR\b/gi, replacement: '‚à®' },
                { pattern: /\bor\b/gi, replacement: '‚à®' },
                { pattern: /\|\|/g, replacement: '‚à®' },
                // NOT variations
                { pattern: /\bNOT\s+/gi, replacement: '¬¨' },
                { pattern: /\bnot\s+/gi, replacement: '¬¨' },
                { pattern: /!\s*/g, replacement: '¬¨' },
                { pattern: /~(?=\w)/g, replacement: '¬¨' },
                // IMPLIES variations
                { pattern: /->/g, replacement: '‚Üí' },
                { pattern: /=>/g, replacement: '‚Üí' },
                { pattern: /\bIMPLIES\b/gi, replacement: '‚Üí' },
                { pattern: /\bimplies\b/gi, replacement: '‚Üí' },
            ];
            
            replacements.forEach(({ pattern, replacement }) => {
                const before = normalized;
                normalized = normalized.replace(pattern, replacement);
                if (before !== normalized) {
                    changed = true;
                }
            });
            
            // Restore variable placeholders
            placeholders.forEach(({ placeholder, original }) => {
                normalized = normalized.replace(placeholder, original);
            });
            
            return { normalized, changed, warnings };
        }
        
        /**
         * Validates logic input for safety and correctness
         * @param {string} expr - Expression to validate
         * @returns {{ok: boolean, errors: string[], stats: {len: number, depth: number, tokens: number}}}
         */
        function validateLogicInput(expr) {
            const result = {
                ok: true,
                errors: [],
                stats: { len: 0, depth: 0, tokens: 0 }
            };
            
            if (!expr || typeof expr !== 'string') {
                result.ok = false;
                result.errors.push('Expression is empty');
                return result;
            }
            
            result.stats.len = expr.length;
            
            // Check length
            if (expr.length > MAX_EXPR_LEN) {
                result.ok = false;
                result.errors.push(`Expression too long (${expr.length} chars, max ${MAX_EXPR_LEN})`);
            }
            
            // Allowed character set: letters, numbers, underscore, whitespace, operators, parentheses
            const allowedChars = /^[a-zA-Z0-9_\s()¬¨‚àß‚à®‚Üí‚Üî,.\-]+$/;
            if (!allowedChars.test(expr)) {
                result.ok = false;
                const invalidChars = expr.split('').filter(c => !allowedChars.test(c));
                const uniqueInvalid = [...new Set(invalidChars)];
                result.errors.push(`Unsupported characters: ${uniqueInvalid.join(', ')}`);
            }
            
            // Check balanced parentheses and calculate depth
            let depth = 0;
            let maxDepth = 0;
            let parenMismatch = false;
            
            for (let i = 0; i < expr.length; i++) {
                if (expr[i] === '(') {
                    depth++;
                    maxDepth = Math.max(maxDepth, depth);
                } else if (expr[i] === ')') {
                    depth--;
                    if (depth < 0) {
                        parenMismatch = true;
                        result.errors.push(`Unbalanced parentheses: extra ')' at position ${i + 1}`);
                        break;
                    }
                }
            }
            
            if (depth > 0) {
                parenMismatch = true;
                result.errors.push(`Unbalanced parentheses: ${depth} unclosed '('`);
            }
            
            if (parenMismatch) {
                result.ok = false;
            }
            
            result.stats.depth = maxDepth;
            
            // Check depth limit
            if (maxDepth > MAX_DEPTH) {
                result.ok = false;
                result.errors.push(`Expression too deeply nested (depth ${maxDepth}, max ${MAX_DEPTH})`);
            }
            
            // Estimate token count (rough: split by operators and whitespace)
            const tokens = expr.split(/[\s¬¨‚àß‚à®‚Üí‚Üî()]+/).filter(t => t.length > 0);
            result.stats.tokens = tokens.length;
            
            if (tokens.length > MAX_TOKENS_FOR_DIAGRAM) {
                result.errors.push(`Expression has many tokens (${tokens.length}). Diagram may be simplified.`);
                // Warning, not fatal
            }
            
            return result;
        }
        
        /**
         * Inserts text at cursor position in a textarea
         * @param {HTMLTextAreaElement} textarea - The textarea element
         * @param {string} text - Text to insert
         */
        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;
            
            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
            
            // Trigger input event for any listeners
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // ============================================================
        // LOGIC VISUALIZATION FUNCTIONS
        // ============================================================
        
        let graphCounter = 0; // For unique mermaid IDs
        let renderDebounceTimer = null; // For debouncing Mermaid renders
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.result-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
        }
        
        function generateMermaidGraph(logicString) {
            /**
             * Parses a formal logic string and generates Mermaid flowchart syntax.
             * Handles: ‚àß (AND), ‚à® (OR), ‚Üí (IMPLIES), ‚Üî (IFF), ¬¨ (NOT)
             */
            
            if (!logicString || logicString.trim().length === 0) {
                return null;
            }
            
            const nodes = [];
            const edges = [];
            let nodeId = 0;
            
            function getNodeId() {
                return `N${nodeId++}`;
            }
            
            function sanitizeLabel(label) {
                // Remove special chars that break mermaid, keep underscores
                return label.replace(/[<>{}|]/g, '').trim();
            }
            
            function parseExpression(expr) {
                expr = expr.trim();
                
                // Remove outer parentheses if they wrap the entire expression
                while (expr.startsWith('(') && expr.endsWith(')')) {
                    let depth = 0;
                    let balanced = true;
                    for (let i = 0; i < expr.length - 1; i++) {
                        if (expr[i] === '(') depth++;
                        if (expr[i] === ')') depth--;
                        if (depth === 0 && i > 0) {
                            balanced = false;
                            break;
                        }
                    }
                    if (balanced) {
                        expr = expr.slice(1, -1).trim();
                    } else {
                        break;
                    }
                }
                
                // Find main operator (lowest precedence first: ‚Üí, ‚Üî, ‚à®, ‚àß)
                const operators = [
                    { symbols: ['‚Üí', '->'], name: 'IMPLIES', label: '‚Üí' },
                    { symbols: ['‚Üî', '<->'], name: 'IFF', label: '‚Üî' },
                    { symbols: ['‚à®', '||', ' or '], name: 'OR', label: '‚à®' },
                    { symbols: ['‚àß', '&&', ' and '], name: 'AND', label: '‚àß' }
                ];
                
                for (const op of operators) {
                    let depth = 0;
                    for (let i = 0; i < expr.length; i++) {
                        if (expr[i] === '(') depth++;
                        if (expr[i] === ')') depth--;
                        
                        if (depth === 0) {
                            for (const sym of op.symbols) {
                                if (expr.substring(i, i + sym.length) === sym) {
                                    const left = expr.substring(0, i).trim();
                                    const right = expr.substring(i + sym.length).trim();
                                    
                                    if (left && right) {
                                        const nodeIdCurrent = getNodeId();
                                        const leftResult = parseExpression(left);
                                        const rightResult = parseExpression(right);
                                        
                                        // Determine node shape based on operator
                                        let nodeShape;
                                        if (op.name === 'AND') {
                                            nodeShape = `${nodeIdCurrent}{{"${op.label} AND"}}`;
                                        } else if (op.name === 'OR') {
                                            nodeShape = `${nodeIdCurrent}{{"${op.label} OR"}}`;
                                        } else if (op.name === 'IMPLIES') {
                                            nodeShape = `${nodeIdCurrent}[/"${op.label} IMPLIES"/]`;
                                        } else {
                                            nodeShape = `${nodeIdCurrent}{{"${op.label}"}}`;
                                        }
                                        
                                        nodes.push(nodeShape);
                                        edges.push(`${leftResult} --> ${nodeIdCurrent}`);
                                        edges.push(`${rightResult} --> ${nodeIdCurrent}`);
                                        
                                        return nodeIdCurrent;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Check for negation
                if (expr.startsWith('¬¨') || expr.startsWith('~') || expr.startsWith('!') || expr.toLowerCase().startsWith('not ')) {
                    const inner = expr.replace(/^(¬¨|~|!|not\s+)/i, '').trim();
                    const innerResult = parseExpression(inner);
                    const nodeIdCurrent = getNodeId();
                    
                    nodes.push(`${nodeIdCurrent}[["¬¨ NOT"]]:::negated`);
                    edges.push(`${innerResult} --> ${nodeIdCurrent}`);
                    
                    return nodeIdCurrent;
                }
                
                // Check for quantifiers (‚àÄ, ‚àÉ)
                const quantifierMatch = expr.match(/^([‚àÄ‚àÉ])\s*(\w+)\s*:\s*(\w+)\s*\.\s*(.+)$/);
                if (quantifierMatch) {
                    const [, quantifier, varName, varType, body] = quantifierMatch;
                    const bodyResult = parseExpression(body);
                    const nodeIdCurrent = getNodeId();
                    
                    const qLabel = quantifier === '‚àÄ' ? 'FOR ALL' : 'EXISTS';
                    nodes.push(`${nodeIdCurrent}[("${quantifier} ${qLabel} ${varName}:${varType}")]`);
                    edges.push(`${bodyResult} --> ${nodeIdCurrent}`);
                    
                    return nodeIdCurrent;
                }
                
                // It's a variable/atom
                const nodeIdCurrent = getNodeId();
                const label = sanitizeLabel(expr);
                nodes.push(`${nodeIdCurrent}["${label}"]`);
                
                return nodeIdCurrent;
            }
            
            try {
                parseExpression(logicString);
                
                if (nodes.length === 0) {
                    return null;
                }
                
                // Build mermaid graph
                let mermaidCode = 'flowchart BT\n';
                mermaidCode += '    classDef negated fill:#2a1a1a,stroke:#ff6b6b,stroke-width:2px\n';
                mermaidCode += '    classDef operator fill:#1e3a5f,stroke:#ffc857,stroke-width:2px\n';
                
                nodes.forEach(node => {
                    mermaidCode += `    ${node}\n`;
                });
                
                edges.forEach(edge => {
                    mermaidCode += `    ${edge}\n`;
                });
                
                return mermaidCode;
            } catch (e) {
                console.error('Error generating graph:', e);
                return null;
            }
        }
        
        async function renderLogicGraph(logicString, isValid) {
            const container = document.getElementById('mermaid-container');
            const legend = document.getElementById('graph-legend');
            const tabs = document.getElementById('result-tabs');
            
            // Validate before rendering (prevent crashes)
            const validation = validateLogicInput(logicString);
            if (!validation.ok) {
                container.innerHTML = '<div class="no-graph-message">Cannot visualize: ' + validation.errors[0] + '</div>';
                legend.style.display = 'none';
                tabs.style.display = 'flex';
                return;
            }
            
            // Check token count (prevent overly complex diagrams)
            if (validation.stats.tokens > MAX_TOKENS_FOR_DIAGRAM) {
                container.innerHTML = `<div class="no-graph-message">Expression too complex to visualize (${validation.stats.tokens} tokens, max ${MAX_TOKENS_FOR_DIAGRAM}). View JSON for details.</div>`;
                legend.style.display = 'none';
                tabs.style.display = 'flex';
                return;
            }
            
            const mermaidCode = generateMermaidGraph(logicString);
            
            if (!mermaidCode) {
                container.innerHTML = '<div class="no-graph-message">Unable to visualize this expression</div>';
                legend.style.display = 'none';
                tabs.style.display = 'flex';
                return;
            }
            
            try {
                // Clear previous graph
                container.innerHTML = '';
                
                // Create unique ID for this render
                graphCounter++;
                const graphId = `logic-graph-${graphCounter}`;
                
                // Render the graph with error handling
                const { svg } = await mermaid.render(graphId, mermaidCode);
                container.innerHTML = svg;
                
                // Show legend and tabs
                legend.style.display = 'flex';
                tabs.style.display = 'flex';
                
                // Default to graph tab on success
                if (isValid) {
                    switchTab('graph');
                }
                
            } catch (e) {
                console.error('Mermaid render error:', e);
                container.innerHTML = '<div class="no-graph-message">Error rendering graph. The expression may be too complex or contain unsupported syntax. View JSON for details.</div>';
                legend.style.display = 'none';
                tabs.style.display = 'flex';
            }
        }
        
        // Debounced version for real-time rendering (if needed in future)
        function renderLogicGraphDebounced(logicString, isValid) {
            if (renderDebounceTimer) {
                clearTimeout(renderDebounceTimer);
            }
            renderDebounceTimer = setTimeout(() => {
                renderLogicGraph(logicString, isValid);
            }, RENDER_DEBOUNCE_MS);
        }
        
        // ============================================================
        // END LOGIC VISUALIZATION FUNCTIONS
        // ============================================================
        
        const formalExamples = {
            coverage: {
                display: "Coverage ‚Üí Approve",
                formal: "((active_policy ‚àß premium_paid) ‚àß (valid_claim_date ‚àß ¬¨excluded_condition)) ‚Üí claim_approved",
                description: "If policy active AND premium paid AND valid date AND not excluded, then approve"
            },
            contradiction: {
                display: "Contradiction",
                formal: "approved ‚àß ¬¨approved",
                description: "Claim is both approved and not approved"
            },
            deductible: {
                display: "Deductible Logic",
                formal: "(deductible_met ‚àß service_covered) ‚Üí (pay ‚àß ¬¨copay_waived)",
                description: "If deductible met AND covered, then pay but don't waive copay"
            },
            circular: {
                display: "Circular Dependency",
                formal: "‚àÄp:Prop . V(p) ‚Üî ¬¨V(p)",
                description: "A rule that references its own negation ‚Äî causes infinite loop"
            }
        };
        
        const businessExamples = {
            coverage: {
                display: "Coverage Check",
                input: "If the patient has active coverage and the claim amount is within the annual limit, then the claim should be approved",
                description: "Natural language coverage rule"
            },
            contradiction: {
                display: "Contradiction",
                input: "The claim is approved and the claim is denied",
                description: "Conflicting approval states"
            },
            deductible: {
                display: "Deductible Logic",
                input: "If the deductible is met and the service is covered, then pay the claim minus copay",
                description: "Payment calculation rule"
            },
            circular: {
                display: "Circular Rule",
                input: "This policy is valid if and only if this policy is not valid",
                description: "Self-referential rule ‚Äî will be flagged as paradox"
            }
        };

        function setMode(mode) {
            currentMode = mode;
            
            // Update toggle buttons
            document.getElementById('mode-formal').style.background = mode === 'formal' ? '#00d4aa' : 'transparent';
            document.getElementById('mode-formal').style.color = mode === 'formal' ? '#0a1628' : '#8b9cb3';
            document.getElementById('mode-business').style.background = mode === 'business' ? '#ffc857' : 'transparent';
            document.getElementById('mode-business').style.color = mode === 'business' ? '#0a1628' : '#8b9cb3';
            
            // Update description
            const descEl = document.getElementById('mode-description');
            if (mode === 'formal') {
                descEl.innerHTML = '<strong style="color: #00d4aa;">Formal Mode:</strong> Deterministic verification via Z3 SMT solver. Use logical notation (‚àß ‚à® ‚Üí ¬¨). Production-grade.';
            } else {
                descEl.innerHTML = '<strong style="color: #ffc857;">Business Mode:</strong> Natural language input with automatic translation. Shows confidence score. For analyst workflows ‚Äî review translations before production use.';
            }
            
            // Update input label
            document.getElementById('input-label').textContent = mode === 'formal' ? 'Formal Logic Expression' : 'Business Rule (Plain English)';
            
            // Update placeholder and default value
            const input = document.getElementById('logic-input');
            if (mode === 'formal') {
                input.placeholder = 'e.g., (A ‚àß B) ‚Üí C';
                input.value = formalExamples.coverage.formal;
                document.getElementById('logic-description').textContent = formalExamples.coverage.description;
            } else {
                input.placeholder = 'e.g., If patient has coverage and claim is valid, then approve';
                input.value = businessExamples.coverage.input;
                document.getElementById('logic-description').textContent = businessExamples.coverage.description;
            }
            
            // Update example chips
            const chipsContainer = document.getElementById('example-chips');
            const examples = mode === 'formal' ? formalExamples : businessExamples;
            chipsContainer.innerHTML = Object.keys(examples).map(key => 
                `<span class="chip" onclick="setExample('${key}')">${examples[key].display}</span>`
            ).join('');
            
            // Update API info
            document.getElementById('api-endpoint-info').textContent = mode === 'formal' 
                ? 'POST /verify ‚Äî Formal verification via Z3 SMT solver (deterministic)'
                : 'POST /verify/natural ‚Äî Natural language translation + verification (shows confidence)';
            
            // Clear previous results
            document.getElementById('logic-result').classList.remove('show');
            
            // Clear validation errors and normalized preview
            document.getElementById('validation-errors').style.display = 'none';
            document.getElementById('normalized-preview').style.display = 'none';
            
            // Re-validate input after mode switch
            if (typeof updateInputValidation === 'function') {
                setTimeout(updateInputValidation, 100);
            }
        }

        function setExample(key) {
            const examples = currentMode === 'formal' ? formalExamples : businessExamples;
            const example = examples[key];
            document.getElementById('logic-input').value = currentMode === 'formal' ? example.formal : example.input;
            document.getElementById('logic-description').textContent = example.description;
        }

        // Check API status on load
        async function checkStatus() {
            const statusEl = document.getElementById('api-status');
            try {
                const response = await fetch(`${CONFIG.GPMSC_API_URL}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit' // Don't send credentials for health check
                });
                if (response.ok) {
                    statusEl.textContent = 'LIVE';
                    statusEl.style.color = '#00d4aa';
                } else {
                    statusEl.textContent = 'DOWN';
                    statusEl.style.color = '#ff6b6b';
                }
            } catch (e) {
                // Check if it's a CORS error
                if (e.message && e.message.includes('CORS')) {
                    statusEl.textContent = 'CORS ERROR';
                    statusEl.style.color = '#ffc857';
                    console.error('CORS Error: The backend needs to add this domain to CORS_ORIGINS:', window.location.origin);
                } else {
                    statusEl.textContent = 'DOWN';
                    statusEl.style.color = '#ff6b6b';
                }
            }
        }

        async function verifyLogic() {
            console.log('=== verifyLogic() called ===');
            
            const btn = document.getElementById('verify-btn');
            const logicInput = document.getElementById('logic-input');
            
            if (!btn) {
                console.error('verify-btn element not found');
                return;
            }
            if (!logicInput) {
                console.error('logic-input element not found');
                return;
            }
            
            const rawInput = logicInput.value.trim();
            const resultDiv = document.getElementById('logic-result');
            const statusEl = document.getElementById('logic-status');
            const timeEl = document.getElementById('logic-time');
            const detailsEl = document.getElementById('logic-details');
            const bodyEl = document.getElementById('logic-body');

            if (!resultDiv || !statusEl || !timeEl || !detailsEl || !bodyEl) {
                console.error('Missing result elements:', {
                    resultDiv: !!resultDiv,
                    statusEl: !!statusEl,
                    timeEl: !!timeEl,
                    detailsEl: !!detailsEl,
                    bodyEl: !!bodyEl
                });
                return;
            }

            if (!rawInput) {
                alert('Please enter a ' + (currentMode === 'formal' ? 'logical expression' : 'business rule') + ' to verify');
                return;
            }
            
            console.log('Input:', rawInput);
            console.log('Mode:', currentMode);

            // Normalize input (for formal mode only)
            let input = rawInput;
            let normalizedResult = null;
            if (currentMode === 'formal') {
                normalizedResult = normalizeLogicInput(rawInput);
                input = normalizedResult.normalized;
            }

            // Validate input
            const validation = validateLogicInput(input);
            if (!validation.ok) {
                // Show validation errors
                const errorsDiv = document.getElementById('validation-errors');
                const errorsList = document.getElementById('validation-errors-list');
                errorsDiv.style.display = 'block';
                errorsList.innerHTML = validation.errors.map(e => `<li>${e}</li>`).join('');
                
                // Disable verify button
                btn.disabled = true;
                btn.innerHTML = 'Fix errors above';
                
                // Show helpful hint
                alert('Please fix the validation errors:\n\n' + validation.errors.join('\n') + '\n\nTip: Use operators ‚àß ‚à® ¬¨ ‚Üí (you can type AND/OR/NOT/->)');
                return;
            }

            // Hide validation errors if validation passed
            document.getElementById('validation-errors').style.display = 'none';
            
            // Show normalized preview if normalization changed the input
            const normalizedPreview = document.getElementById('normalized-preview');
            const normalizedText = document.getElementById('normalized-text');
            if (normalizedResult && normalizedResult.changed) {
                normalizedPreview.style.display = 'block';
                normalizedText.textContent = input;
            } else {
                normalizedPreview.style.display = 'none';
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Verifying...';
            resultDiv.classList.add('show');
            statusEl.textContent = 'Processing...';
            statusEl.className = 'result-status';
            detailsEl.innerHTML = '';
            bodyEl.textContent = '';

            const startTime = Date.now();

            try {
                let response, data;
                let isLogicallyValid = false; // Declare in outer scope for graph rendering
                
                if (currentMode === 'formal') {
                    // Formal mode - use /verify endpoint
                    response = await fetch(`${CONFIG.GPMSC_API_URL}/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ proposition: input })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(errorData.detail || errorData.message || `HTTP ${response.status}`);
                    }
                    data = await response.json();
                    
                    const elapsed = Date.now() - startTime;
                    timeEl.textContent = `${elapsed}ms`;

                    // Determine logical validity: valid syntax AND no paradox AND satisfiable (not a contradiction)
                    // Detect contradictions via:
                    // 1. Explicit "unsat" status from SMT solver
                    // 2. Simple contradiction patterns like "X ‚àß ¬¨X" (detected client-side when SMT errors)
                    const proposition = input.trim();
                    const isSimpleContradiction = (() => {
                        // Match patterns like "X ‚àß ¬¨X" where X appears on both sides with negation
                        // Pattern: identifier, then ‚àß or &, then ¬¨, then the same identifier
                        const pattern = /^([^\s‚àß&‚Üí‚Üî()]+)\s*[‚àß&]\s*¬¨\s*\1\s*$/;
                        return pattern.test(proposition);
                    })();
                    const isContradiction = data.smt_status === "unsat" || isSimpleContradiction;
                    isLogicallyValid = data.valid && !data.paradox_detected && !isContradiction;
                    
                    // Determine result status
                    if (data.paradox_detected) {
                        statusEl.textContent = '‚ö†Ô∏è PARADOX / CIRCULAR DEPENDENCY';
                        statusEl.className = 'result-status warning';
                    } else if (!isLogicallyValid) {
                        statusEl.textContent = '‚úó INVALID / CONTRADICTION';
                        statusEl.className = 'result-status error';
                    } else {
                        statusEl.textContent = '‚úì LOGICALLY VALID';
                        statusEl.className = 'result-status success';
                    }

                    // Determine deployment risk
                    let riskLevel = 'LOW ‚Äî Safe to deploy';
                    let riskClass = '';
                    if (data.paradox_detected) {
                        riskLevel = 'CRITICAL ‚Äî Circular dependency detected';
                        riskClass = 'warning';
                    } else if (!isLogicallyValid) {
                        riskLevel = 'HIGH ‚Äî Rule contains logical contradiction';
                        riskClass = 'invalid';
                    }

                    const smtResult = data.smt_result || data.smt_satisfiable;
                    const smtDisplay = smtResult === true ? 'Satisfiable ‚úì' : 
                                       smtResult === false ? 'Unsatisfiable (contradiction)' : 
                                       'N/A';

                    // Format timestamp if available
                    const timestamp = data.timestamp || data.proof?.timestamp || new Date().toISOString();
                    const timestampDisplay = new Date(timestamp).toLocaleString();
                    
                    // Get hash
                    const hash = data.hash || data.proof?.hash || 'N/A';
                    const hashDisplay = hash !== 'N/A' ? hash.substring(0, 16) + '...' : 'N/A';
                    
                    detailsEl.innerHTML = `
                        <div class="verification-row">
                            <span class="verification-label">Verification Result:</span>
                            <span class="verification-value ${isLogicallyValid ? '' : 'invalid'}">${isLogicallyValid ? 'PASS' : 'FAIL'}</span>
                        </div>
                        <div class="verification-row">
                            <span class="verification-label">Paradox Detected:</span>
                            <span class="verification-value ${data.paradox_detected ? 'warning' : ''}">${data.paradox_detected ? 'YES ‚Äî ' + (data.paradox_type || 'Self-reference') : 'None'}</span>
                        </div>
                        <div class="verification-row">
                            <span class="verification-label">SMT Solver (Z3):</span>
                            <span class="verification-value">${smtDisplay}</span>
                        </div>
                        ${data.solver_time_ms !== undefined ? `
                        <div class="verification-row">
                            <span class="verification-label">Solver Time:</span>
                            <span class="verification-value">${data.solver_time_ms.toFixed(2)}ms</span>
                        </div>
                        ` : ''}
                        <div class="verification-row">
                            <span class="verification-label">Deployment Risk:</span>
                            <span class="verification-value ${riskClass}">${riskLevel}</span>
                        </div>
                        ${data.coherence_score !== undefined ? `
                        <div class="verification-row">
                            <span class="verification-label">Coherence Score:</span>
                            <span class="verification-value">${(data.coherence_score * 100).toFixed(1)}%</span>
                        </div>
                        ` : ''}
                        <div class="verification-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #2d4a6f;">
                            <span class="verification-label">Timestamp:</span>
                            <span class="verification-value" style="font-size: 11px;">${timestampDisplay}</span>
                        </div>
                        <div class="verification-row">
                            <span class="verification-label">Hash:</span>
                            <span class="verification-value" style="font-size: 10px; font-family: monospace; word-break: break-all;">${hashDisplay}</span>
                        </div>
                        ${data.audit_id ? `
                        <div class="verification-row">
                            <span class="verification-label">Audit ID:</span>
                            <span class="verification-value" style="font-size: 10px; font-family: monospace;">${data.audit_id}</span>
                        </div>
                        ` : ''}
                        ${data.proof?.anchor_id ? `
                        <div class="verification-row">
                            <span class="verification-label">Anchor ID:</span>
                            <span class="verification-value" style="font-size: 10px; font-family: monospace;">${data.proof.anchor_id}</span>
                        </div>
                        ` : ''}
                    `;
                } else {
                    // Business mode - use /verify/natural endpoint
                    response = await fetch(`${CONFIG.GPMSC_API_URL}/verify/natural`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ statement: input })
                    });
                    data = await response.json();
                    
                    const elapsed = Date.now() - startTime;
                    timeEl.textContent = `${elapsed}ms`;

                    // Set validity for graph rendering
                    isLogicallyValid = data.is_logically_valid && !data.is_paradox;

                    // Determine result status
                    if (data.is_paradox) {
                        statusEl.textContent = '‚ö†Ô∏è PARADOX / CIRCULAR RULE';
                        statusEl.className = 'result-status warning';
                    } else if (data.is_logically_valid) {
                        statusEl.textContent = '‚úì LOGICALLY CONSISTENT';
                        statusEl.className = 'result-status success';
                    } else {
                        statusEl.textContent = '‚úó POTENTIAL ISSUE';
                        statusEl.className = 'result-status error';
                    }

                    // Confidence-based risk assessment
                    let riskLevel, riskClass;
                    const confidence = data.confidence || 0;
                    if (data.is_paradox) {
                        riskLevel = 'HIGH ‚Äî Circular dependency detected';
                        riskClass = 'warning';
                    } else if (!data.is_logically_valid) {
                        riskLevel = 'MEDIUM ‚Äî Review recommended';
                        riskClass = 'invalid';
                    } else if (confidence < 0.7) {
                        riskLevel = 'MEDIUM ‚Äî Low translation confidence, verify formally';
                        riskClass = 'warning';
                    } else {
                        riskLevel = 'LOW ‚Äî Appears consistent';
                        riskClass = '';
                    }

                    // Format timestamp if available
                    const timestamp = data.timestamp || data.proof?.timestamp || new Date().toISOString();
                    const timestampDisplay = new Date(timestamp).toLocaleString();
                    
                    // Get hash
                    const hash = data.hash || data.proof?.hash || 'N/A';
                    const hashDisplay = hash !== 'N/A' ? hash.substring(0, 16) + '...' : 'N/A';
                    
                    detailsEl.innerHTML = `
                        <div class="verification-row">
                            <span class="verification-label">Logical Consistency:</span>
                            <span class="verification-value ${data.is_logically_valid ? '' : 'invalid'}">${data.is_logically_valid ? 'PASS' : 'FAIL'}</span>
                        </div>
                        <div class="verification-row">
                            <span class="verification-label">Paradox Detected:</span>
                            <span class="verification-value ${data.is_paradox ? 'warning' : ''}">${data.is_paradox ? 'YES' + (data.paradox_type ? ' ‚Äî ' + data.paradox_type : '') : 'None'}</span>
                        </div>
                        <div class="verification-row">
                            <span class="verification-label">Translation Confidence:</span>
                            <span class="verification-value ${confidence < 0.7 ? 'warning' : ''}">${(confidence * 100).toFixed(0)}%</span>
                        </div>
                        ${data.processing_time_ms !== undefined ? `
                        <div class="verification-row">
                            <span class="verification-label">Processing Time:</span>
                            <span class="verification-value">${data.processing_time_ms.toFixed(2)}ms</span>
                        </div>
                        ` : ''}
                        ${data.normalized_statement && data.normalized_statement !== input ? `
                        <div class="verification-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #2d4a6f;">
                            <span class="verification-label" style="color: #ffc857;">üìù Normalized:</span>
                            <span class="verification-value" style="color: #8b9cb3; font-size: 11px; font-style: italic;">${data.normalized_statement}</span>
                        </div>
                        ` : ''}
                        ${data.transforms_applied && data.transforms_applied.length > 0 ? `
                        <div class="verification-row" style="margin-top: 6px;">
                            <span class="verification-label" style="color: #ffc857;">üîß Transforms Applied:</span>
                            <span class="verification-value" style="color: #8b9cb3; font-size: 10px;">
                                <ul style="margin: 4px 0 0 0; padding-left: 20px;">
                                    ${data.transforms_applied.map(t => `<li>${t}</li>`).join('')}
                                </ul>
                            </span>
                        </div>
                        ` : ''}
                        ${data.formal_translation ? `
                        <div class="verification-row">
                            <span class="verification-label">Translated To:</span>
                            <span class="verification-value" style="font-family: monospace; font-size: 10px;">${data.formal_translation}</span>
                        </div>
                        ` : ''}
                        ${data.pattern_type ? `
                        <div class="verification-row">
                            <span class="verification-label">Pattern Type:</span>
                            <span class="verification-value" style="font-size: 10px; text-transform: capitalize;">${data.pattern_type.replace(/_/g, ' ')}</span>
                        </div>
                        ` : ''}
                        <div class="verification-row">
                            <span class="verification-label">Deployment Risk:</span>
                            <span class="verification-value ${riskClass}">${riskLevel}</span>
                        </div>
                        <div class="verification-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #2d4a6f;">
                            <span class="verification-label">Timestamp:</span>
                            <span class="verification-value" style="font-size: 11px;">${timestampDisplay}</span>
                        </div>
                        <div class="verification-row">
                            <span class="verification-label">Hash:</span>
                            <span class="verification-value" style="font-size: 10px; font-family: monospace; word-break: break-all;">${hashDisplay}</span>
                        </div>
                        ${data.audit_id ? `
                        <div class="verification-row">
                            <span class="verification-label">Audit ID:</span>
                            <span class="verification-value" style="font-size: 10px; font-family: monospace;">${data.audit_id}</span>
                        </div>
                        ` : ''}
                        ${data.anchor_id ? `
                        <div class="verification-row">
                            <span class="verification-label">Anchor ID:</span>
                            <span class="verification-value" style="font-size: 10px; font-family: monospace;">${data.anchor_id}</span>
                        </div>
                        ` : ''}
                        <div class="verification-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #2d4a6f;">
                            <span class="verification-label" style="color: #ffc857;">‚ö†Ô∏è Note:</span>
                            <span class="verification-value" style="color: #8b9cb3; font-size: 10px;">Business mode uses deterministic preprocessing + NLP translation. All transforms are logged for audit compliance.</span>
                        </div>
                    `;
                }

                bodyEl.textContent = JSON.stringify(data, null, 2);

                // Render logic visualization graph
                const expressionToVisualize = currentMode === 'formal' 
                    ? input 
                    : (data.formal_translation || input);
                await renderLogicGraph(expressionToVisualize, isLogicallyValid);

                // Auto-fill audit ID if present
                const auditId = data?.audit_id || data?.proof?.anchor_id;
                if (auditId) {
                    const gameIdInput = document.getElementById('game-id');
                    gameIdInput.value = auditId;
                    
                    // Add highlight class
                    gameIdInput.classList.add('audit-highlight');
                    
                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        gameIdInput.classList.remove('audit-highlight');
                    }, 2000);
                }

            } catch (e) {
                console.error('Error in verifyLogic:', e);
                statusEl.textContent = '‚úó ERROR';
                statusEl.className = 'result-status error';
                timeEl.textContent = `${Date.now() - startTime}ms`;
                
                // Show better error message with hints
                const errorMsg = e.message || 'Unknown error';
                const normalizedHint = normalizedResult && normalizedResult.changed 
                    ? `\n\nNormalized expression sent: ${input}` 
                    : '';
                const hint = `\n\nTip: Use operators: ‚àß ‚à® ¬¨ ‚Üí (you can type AND/OR/NOT/->)`;
                
                bodyEl.innerHTML = `
                    <div style="color: #ff6b6b; margin-bottom: 10px;">
                        <strong>Error:</strong> ${errorMsg}
                    </div>
                    ${normalizedResult && normalizedResult.changed ? `
                    <div style="color: #ffc857; margin-bottom: 10px;">
                        <strong>Normalized expression sent:</strong> ${input}
                    </div>
                    ` : ''}
                    <div style="color: #8b9cb3; font-size: 11px;">
                        ${hint}
                    </div>
                `;
            }

            btn.disabled = false;
            btn.textContent = 'Verify Rule Consistency';
        }

        // VERSION: 2024-12-19-v6 - RENAMED from verifyGame to verifyAuditIntegrity to break cache
        // OLD FUNCTION verifyGame() DELETED - DO NOT USE
        
        // Override old verifyGame function if it exists (from cached code)
        if (typeof verifyGame !== 'undefined') {
            console.error('‚ùå‚ùå‚ùå OLD CACHED CODE DETECTED: verifyGame() function exists!');
            console.error('This means you are running OLD CACHED CODE from Vercel!');
            window.verifyGame = function() {
                alert('ERROR: You are running OLD CACHED CODE. Please:\n1. Hard refresh (Ctrl+Shift+R)\n2. Clear browser cache\n3. Try incognito mode');
                throw new Error('OLD CACHED CODE - verifyGame() should not exist');
            };
        }
        
        async function verifyAuditIntegrity() {
            console.log('=== verifyAuditIntegrity() called - VERSION: 2024-12-19-v6 ===');
            console.log('‚úÖ This is the NEW function - using GPMSC API only');
            
            const btn = document.getElementById('game-btn');
            const gameIdInput = document.getElementById('game-id');
            
            if (!btn) {
                console.error('game-btn element not found');
                return;
            }
            if (!gameIdInput) {
                console.error('game-id element not found');
                return;
            }
            
            const auditId = gameIdInput.value.trim();
            const resultDiv = document.getElementById('game-result');
            const statusEl = document.getElementById('game-status');
            const timeEl = document.getElementById('game-time');
            const detailsEl = document.getElementById('game-details');
            const bodyEl = document.getElementById('game-body');
            
            if (!resultDiv || !statusEl || !timeEl || !detailsEl || !bodyEl) {
                console.error('Missing result elements:', {
                    resultDiv: !!resultDiv,
                    statusEl: !!statusEl,
                    timeEl: !!timeEl,
                    detailsEl: !!detailsEl,
                    bodyEl: !!bodyEl
                });
                return;
            }
            
            console.log('Audit ID:', auditId);

            if (!auditId) {
                alert('Please enter an audit record ID');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Verifying...';
            resultDiv.classList.add('show');
            statusEl.textContent = 'Processing...';
            statusEl.className = 'result-status';
            detailsEl.innerHTML = '';
            bodyEl.textContent = '';

            const startTime = Date.now();

            try {
                // CRITICAL: Audit log is stored in GPMSC API database, NOT ProofPlay
                // Use GPMSC audit integrity endpoint (not ProofPlay games endpoint)
                
                // VERIFY CONFIG IS CORRECT
                console.log('=== AUDIT VERIFICATION DEBUG ===');
                console.log('CONFIG object:', JSON.stringify(CONFIG, null, 2));
                console.log('CONFIG.GPMSC_API_URL:', CONFIG.GPMSC_API_URL);
                console.log('CONFIG.PROOFPLAY_API_URL:', CONFIG.PROOFPLAY_API_URL);
                
                const baseUrl = CONFIG.GPMSC_API_URL;
                console.log('Using baseUrl:', baseUrl);
                console.log('Audit ID to verify:', auditId);
                
                // HARD STOP if trying to use ProofPlay - check multiple ways
                const isProofPlay = baseUrl.includes('proofplay') || 
                                   baseUrl.toLowerCase().includes('proofplay') ||
                                   baseUrl.includes('proofplay-sx3q') ||
                                   baseUrl.includes('sx3q.onrender.com');
                
                if (isProofPlay) {
                    console.error('‚ùå‚ùå‚ùå FATAL ERROR: CONFIG.GPMSC_API_URL is pointing to ProofPlay!');
                    console.error('CONFIG.GPMSC_API_URL:', baseUrl);
                    console.error('This is WRONG! Audit log is in GPMSC API, not ProofPlay!');
                    alert('ERROR: Configuration is pointing to ProofPlay API. Audit log is in GPMSC API. Please refresh the page.');
                    throw new Error('CRITICAL ERROR: Configuration is pointing to ProofPlay API. Audit log is in GPMSC API. Please refresh the page with ?gpmsc=https://gpmsc-api.onrender.com');
                }
                
                // Build URL and verify it's correct
                const url = `${baseUrl}/audit/${auditId}/integrity`;
                console.log('‚úÖ Built URL:', url);
                
                // Triple-check URL doesn't contain proofplay
                if (url.includes('proofplay') || url.includes('sx3q')) {
                    console.error('‚ùå‚ùå‚ùå FATAL ERROR: Generated URL contains proofplay!', url);
                    alert('ERROR: Generated URL points to ProofPlay. This should never happen.');
                    throw new Error('CRITICAL ERROR: Generated URL points to ProofPlay. This should never happen. Please report this bug.');
                }
                
                // Verify it's the correct endpoint pattern
                if (!url.includes('/audit/') || !url.includes('/integrity')) {
                    console.error('‚ùå ERROR: URL does not match expected pattern /audit/{id}/integrity');
                    throw new Error('Invalid audit endpoint URL');
                }
                
                console.log('‚úÖ Making fetch request to:', url);
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                console.log('Response status:', response.status);
                const elapsed = Date.now() - startTime;
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Audit record not found. Make sure you're using an audit_id from a GPMSC /verify response, not from ProofPlay.`);
                    } else if (response.status === 502) {
                        throw new Error(`Backend service unavailable (502). The service may be restarting. Please try again in a moment.`);
                    } else if (response.status >= 500) {
                        throw new Error(`Server error (${response.status}). Please try again later.`);
                    }
                    throw new Error(`Request failed (${response.status})`);
                }

                const data = await response.json();
                timeEl.textContent = `${elapsed}ms`;

                // Determine status based on integrity_verified and chain_intact
                const integrityVerified = data.integrity_verified === true;
                const chainIntact = data.chain_intact === true;

                if (integrityVerified && chainIntact) {
                    statusEl.textContent = '‚úì INTEGRITY VERIFIED';
                    statusEl.className = 'result-status success';
                } else if (integrityVerified) {
                    statusEl.textContent = '‚ö†Ô∏è PARTIAL VERIFICATION';
                    statusEl.className = 'result-status warning';
                } else {
                    statusEl.textContent = '‚úó INTEGRITY FAILED';
                    statusEl.className = 'result-status error';
                }

                // Check for RFC3161 TSA timestamp token
                const hasTSAToken = data.tsa_token || (data.anchor_id && data.anchor_id.startsWith('tsa_'));
                const legalSealBadge = hasTSAToken ? `
                    <div class="legal-seal-badge" title="Verified by External Time Stamping Authority (RFC 3161)">
                        ‚öñÔ∏è Legally Timestamped
                    </div>
                ` : '';

                detailsEl.innerHTML = `
                    ${legalSealBadge}
                    <div class="verification-row">
                        <span class="verification-label">Record ID:</span>
                        <span class="verification-value">${data.record_id || auditId}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Integrity Verified:</span>
                        <span class="verification-value ${integrityVerified ? '' : 'invalid'}">${integrityVerified ? '‚úì YES' : '‚úó NO'}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Chain Intact:</span>
                        <span class="verification-value ${chainIntact ? '' : 'invalid'}">${chainIntact ? '‚úì YES' : '‚úó NO'}</span>
                    </div>
                    ${data.calculated_hash ? `
                    <div class="verification-row">
                        <span class="verification-label">Calculated Hash:</span>
                        <span class="verification-value" style="font-size: 10px; word-break: break-all;">${data.calculated_hash.substring(0, 16)}...</span>
                    </div>
                    ` : ''}
                    ${data.stored_hash ? `
                    <div class="verification-row">
                        <span class="verification-label">Stored Hash:</span>
                        <span class="verification-value" style="font-size: 10px; word-break: break-all;">${data.stored_hash.substring(0, 16)}...</span>
                    </div>
                    ` : ''}
                    ${data.error ? `
                    <div class="verification-row">
                        <span class="verification-label">Error:</span>
                        <span class="verification-value invalid">${data.error}</span>
                    </div>
                    ` : ''}
                `;

                bodyEl.textContent = JSON.stringify(data, null, 2);

            } catch (e) {
                console.error('Error in verifyAuditIntegrity:', e);
                statusEl.textContent = '‚úó ERROR';
                statusEl.className = 'result-status error';
                timeEl.textContent = `${Date.now() - startTime}ms`;
                
                // Show better error message
                let errorMsg = e.message || 'Unknown error';
                let helpText = '';
                
                // Check for CORS error
                if (errorMsg.includes('CORS') || errorMsg.includes('Access-Control-Allow-Origin') || errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'CORS Error: Backend not configured for this domain';
                    helpText = '<br><small style="color: #8b9cb3;">The backend needs to add this domain to CORS_ORIGINS environment variable.</small>';
                } else if (errorMsg.includes('502') || errorMsg.includes('Bad Gateway')) {
                    errorMsg = 'Backend service unavailable (502)';
                    helpText = '<br><small style="color: #8b9cb3;">The backend service may be restarting or down. Please try again in a moment.</small>';
                }
                
                bodyEl.innerHTML = `
                    <div style="color: #ff6b6b; margin-bottom: 10px;">
                        <strong>Error:</strong> ${errorMsg}
                    </div>
                    ${helpText ? `<div style="color: #8b9cb3; font-size: 11px;">${helpText}</div>` : ''}
                `;
            }

            btn.disabled = false;
            btn.textContent = 'Verify Audit Integrity';
        }

        async function loadAuditStream() {
            console.log('=== loadAuditStream() called ===');
            
            const tbody = document.getElementById('audit-stream-body');
            
            if (!tbody) {
                console.error('‚ùå Audit stream body element not found');
                return;
            }
            
            if (!CONFIG || !CONFIG.GPMSC_API_URL) {
                console.error('‚ùå CONFIG or CONFIG.GPMSC_API_URL not defined');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #ff6b6b; padding: 20px;">
                            Configuration error: CONFIG.GPMSC_API_URL not defined
                        </td>
                    </tr>
                `;
                return;
            }
            
            try {
                const url = `${CONFIG.GPMSC_API_URL}/audit/recent?limit=10`;
                console.log('Loading audit stream from:', url);
                console.log('CONFIG object:', CONFIG);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                console.log('Audit stream response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Audit stream error response:', errorText);
                    throw new Error(`Failed to load audit stream: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Audit stream data received:', data);
                
                const records = data.records || [];
                
                console.log('Audit stream records received:', records.length);
                if (records.length > 0) {
                    console.log('Sample record:', records[0]);
                }
                
                if (records.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; color: #8b9cb3; padding: 20px;">
                                No audit records yet. Run a verification to see records here.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = records.map(record => {
                    const timestamp = new Date(record.timestamp).toLocaleString();
                    
                    // Determine status text and class
                    let statusText = '‚Äî';
                    let statusClass = '';
                    
                    // Check valid status (can be true, false, or null/undefined)
                    if (record.valid === true) {
                        statusText = 'Valid';
                        statusClass = 'audit-status-valid';
                    } else if (record.valid === false) {
                        statusText = 'Invalid';
                        statusClass = 'audit-status-invalid';
                    } else if (record.status) {
                        // Use status from backend (sat, unsat, paradox, contradiction, valid, invalid, etc.)
                        const statusLower = record.status.toLowerCase();
                        if (statusLower === 'sat' || statusLower === 'valid') {
                            statusText = 'Valid';
                            statusClass = 'audit-status-valid';
                        } else if (statusLower === 'unsat' || statusLower === 'invalid' || statusLower === 'contradiction') {
                            statusText = 'Invalid';
                            statusClass = 'audit-status-invalid';
                        } else if (statusLower === 'paradox') {
                            statusText = 'Paradox';
                            statusClass = 'audit-status-warning';
                        } else {
                            statusText = record.status.charAt(0).toUpperCase() + record.status.slice(1);
                            statusClass = '';
                        }
                    }
                    
                    // Get the ID - try multiple fields (backend returns both id and audit_id)
                    // IMPORTANT: Use the FULL audit_id, not a shortened version
                    const recordId = record.id || record.audit_id || 'N/A';
                    const shortId = recordId !== 'N/A' ? recordId.substring(0, 8) + '...' : 'N/A';
                    
                    // Get endpoint - try multiple fields and format nicely
                    let endpointDisplay = record.endpoint || record.operation || '‚Äî';
                    // Format endpoint for display (remove leading slash if present)
                    if (endpointDisplay && endpointDisplay.startsWith('/')) {
                        endpointDisplay = endpointDisplay.substring(1);
                    }
                    // Replace underscores with spaces and capitalize words
                    if (endpointDisplay && endpointDisplay !== '‚Äî') {
                        endpointDisplay = endpointDisplay.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                    
                    // Escape the FULL recordId for use in HTML attribute to prevent XSS and ensure proper passing
                    // CRITICAL: Pass the FULL ID, not the shortened version
                    const escapedRecordId = recordId !== 'N/A' ? recordId.replace(/'/g, "\\'").replace(/"/g, '&quot;') : 'N/A';
                    
                    return `
                        <tr>
                            <td>${timestamp}</td>
                            <td>${endpointDisplay}</td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>
                                <span class="audit-id-link" onclick="selectAuditId('${escapedRecordId}')" data-audit-id="${escapedRecordId}" title="Click to verify: ${escapedRecordId}">${shortId}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                let errorMsg = e.message || 'Unknown error';
                let helpText = '';
                
                // Check for CORS error
                if (errorMsg.includes('CORS') || errorMsg.includes('Access-Control-Allow-Origin') || errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'CORS Error: Backend not configured for this domain';
                    helpText = '<br><small style="color: #8b9cb3;">The backend needs to add this domain to CORS_ORIGINS environment variable.</small>';
                } else if (errorMsg.includes('502') || errorMsg.includes('Bad Gateway')) {
                    errorMsg = 'Backend service unavailable (502)';
                    helpText = '<br><small style="color: #8b9cb3;">The backend service may be restarting or down. Please try again in a moment.</small>';
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #ff6b6b; padding: 20px;">
                            Error loading audit stream: ${errorMsg}${helpText}
                        </td>
                    </tr>
                `;
            }
        }

        function selectAuditId(auditId) {
            console.log('=== selectAuditId called ===');
            console.log('Received auditId:', auditId);
            console.log('Type:', typeof auditId);
            console.log('Length:', auditId ? auditId.length : 0);
            
            if (!auditId || auditId === 'N/A') {
                console.error('Invalid audit ID:', auditId);
                alert('Invalid audit ID. Please try clicking a different record.');
                return;
            }
            
            // Populate the input field with the FULL audit ID
            const inputField = document.getElementById('game-id');
            if (!inputField) {
                console.error('Input field #game-id not found');
                return;
            }
            
            // Set the FULL ID (not shortened)
            inputField.value = auditId;
            console.log('Set input field value to:', inputField.value);
            console.log('Input field value length:', inputField.value.length);
            
            // Verify the value was set correctly
            if (inputField.value !== auditId) {
                console.error('Value mismatch! Expected:', auditId, 'Got:', inputField.value);
                // Force set it again
                inputField.value = auditId;
            }
            
            // Highlight it
            inputField.classList.add('audit-highlight');
            setTimeout(() => {
                inputField.classList.remove('audit-highlight');
            }, 2000);
            
            // Automatically verify (with a small delay to ensure value is set)
            setTimeout(() => {
                const currentValue = document.getElementById('game-id').value;
                console.log('About to call verifyAuditIntegrity with value:', currentValue);
                console.log('Value matches expected:', currentValue === auditId);
                verifyAuditIntegrity();
            }, 150); // Slightly longer delay to ensure DOM is updated
        }

        // ============================================================
        // REAL-TIME INPUT VALIDATION
        // ============================================================
        
        function updateInputValidation() {
            const input = document.getElementById('logic-input');
            const rawInput = input.value.trim();
            const btn = document.getElementById('verify-btn');
            const errorsDiv = document.getElementById('validation-errors');
            const errorsList = document.getElementById('validation-errors-list');
            const normalizedPreview = document.getElementById('normalized-preview');
            const normalizedText = document.getElementById('normalized-text');
            
            // Only validate in formal mode
            if (currentMode !== 'formal' || !rawInput) {
                errorsDiv.style.display = 'none';
                normalizedPreview.style.display = 'none';
                btn.disabled = false;
                return;
            }
            
            // Normalize
            const normalizedResult = normalizeLogicInput(rawInput);
            const normalized = normalizedResult.normalized;
            
            // Show normalized preview if changed
            if (normalizedResult.changed) {
                normalizedPreview.style.display = 'block';
                normalizedText.textContent = normalized;
            } else {
                normalizedPreview.style.display = 'none';
            }
            
            // Validate
            const validation = validateLogicInput(normalized);
            if (!validation.ok) {
                errorsDiv.style.display = 'block';
                errorsList.innerHTML = validation.errors.map(e => `<li>${e}</li>`).join('');
                btn.disabled = true;
            } else {
                errorsDiv.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        // Initialize on page load (after all functions are defined)
        console.log('=== Initializing page ===');
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOMContentLoaded - initializing functions');
                checkStatus();
                loadAuditStream();
                
                const input = document.getElementById('logic-input');
                if (input) {
                    input.addEventListener('input', updateInputValidation);
                    input.addEventListener('blur', updateInputValidation);
                    updateInputValidation();
                } else {
                    console.warn('logic-input element not found on DOMContentLoaded');
                }
            });
        } else {
            // DOM already loaded
            console.log('DOM already loaded - initializing functions immediately');
            checkStatus();
            loadAuditStream();
            
            const input = document.getElementById('logic-input');
            if (input) {
                input.addEventListener('input', updateInputValidation);
                input.addEventListener('blur', updateInputValidation);
                updateInputValidation();
            } else {
                console.warn('logic-input element not found');
            }
        }
    </script>
</body>
</html>
